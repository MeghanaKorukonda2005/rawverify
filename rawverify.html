<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrity Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }
        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 100%;
            text-align: center;
        }
        .video-container {
            width: 100%;
            background-color: #000;
            border-radius: 8px;
            margin-top: 1rem;
            overflow: hidden;
            position: relative;
            aspect-ratio: 16/9;
        }
        #video, #canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .controls {
            margin-top: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
        }
        .button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        .button-primary {
            background-color: #4f46e5;
            color: white;
        }
        .button-primary:hover {
            background-color: #4338ca;
        }
        .result-box {
            margin-top: 2rem;
            padding: 1rem;
            background-color: #f9fafb;
            border: 1px dashed #d1d5db;
            border-radius: 8px;
            min-height: 100px;
            text-align: left;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-top: 1rem;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.75rem;
        }
        .status-pending { background-color: #fef3c7; color: #a16207; }
        .status-uploaded { background-color: #d1fae5; color: #065f46; }
        .status-verified { background-color: #cffafe; color: #0891b2; }
        .status-ordered { background-color: #e0f2fe; color: #0369a1; }
        .status-paid { background-color: #cce3d2; color: #1e5c3e; }

    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug');

        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let userId = '';
        window.firebase = {
            db, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, appId, userId
        };

        if (typeof __initial_auth_token !== 'undefined') {
            signInWithCustomToken(auth, __initial_auth_token).then(() => {
                console.log('Signed in with custom token.');
            }).catch((error) => {
                console.error("Error signing in with custom token:", error);
                signInAnonymously(auth);
            });
        } else {
            signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                window.firebase.userId = userId; // Update the window.firebase object
                console.log('User authenticated with ID:', userId);
                initApp();
            } else {
                console.log('No user is signed in.');
            }
        });

        const initApp = () => {
            ({ db, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, appId, userId } = window.firebase);
            console.log("App initialized with user ID:", userId);
            
            roleSelectScreen.classList.remove('hidden');

            buyerBtn.addEventListener('click', () => setRole('buyer'));
            sellerBtn.addEventListener('click', () => setRole('seller'));
        };
    </script>
</head>
<body>

<div class="container" id="main-app">
    <h1 class="text-3xl font-bold text-gray-900 mb-2">Integrity Hub</h1>
    <p class="text-gray-600 mb-6">Connecting buyers and sellers with transparency.</p>
    
    <!-- Role Selection Screen -->
    <div id="role-select" class="flex flex-col gap-4">
        <h2 class="text-xl font-semibold text-gray-800">Choose your role to begin:</h2>
        <button id="buyer-btn" class="button button-primary">I am a Buyer</button>
        <button id="seller-btn" class="button button-primary">I am a Seller</button>
    </div>

    <!-- Buyer Dashboard -->
    <div id="buyer-dashboard" class="hidden">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Buyer Dashboard</h2>
        <div class="card mb-4">
            <h3 class="text-lg font-semibold mb-2">Request a Product</h3>
            <select id="product-select" class="w-full p-2 border border-gray-300 rounded-md mb-2">
                <option value="Cement">Cement</option>
                <option value="Steel">Steel</option>
                <option value="Sand">Sand</option>
                <option value="Bricks">Bricks</option>
            </select>
            <button id="request-product-btn" class="button button-primary w-full">Request Product</button>
        </div>
        <div id="buyer-requests-list" class="flex flex-col gap-4">
            <h3 class="text-lg font-semibold">Your Requests</h3>
            <!-- Buyer requests will be dynamically inserted here -->
        </div>
    </div>

    <!-- Seller Dashboard -->
    <div id="seller-dashboard" class="hidden">
        <h2 class="text-xl font-semibold mb-4 text-gray-800">Seller Dashboard</h2>
        <div id="seller-requests-list" class="flex flex-col gap-4">
            <h3 class="text-lg font-semibold">Open Buyer Requests</h3>
            <!-- Seller requests will be dynamically inserted here -->
        </div>

        <div id="upload-section" class="hidden mt-6">
            <div class="card">
                <h3 class="text-lg font-semibold mb-2">Fulfill Request</h3>
                <div id="locationInfo" class="text-sm text-gray-500 mb-4 hidden">
                    <p><span class="font-semibold">Location:</span> <span id="locationText">Awaiting location...</span></p>
                </div>
                <div class="video-container">
                    <video id="video" autoplay></video>
                    <canvas id="canvas" style="display: none;"></canvas>
                </div>
                <button id="start-webcam-btn" class="button button-primary w-full mt-4">Start Webcam</button>
                <button id="capture-image-btn" class="button button-primary hidden w-full mt-4">Capture & Upload</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    document.addEventListener('DOMContentLoaded', () => {
        let db, auth, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, appId, userId;

        const roleSelectScreen = document.getElementById('role-select');
        const buyerDashboard = document.getElementById('buyer-dashboard');
        const sellerDashboard = document.getElementById('seller-dashboard');
        const buyerBtn = document.getElementById('buyer-btn');
        const sellerBtn = document.getElementById('seller-btn');
        const requestProductBtn = document.getElementById('request-product-btn');
        const productSelect = document.getElementById('product-select');
        const buyerRequestsList = document.getElementById('buyer-requests-list');
        const sellerRequestsList = document.getElementById('seller-requests-list');
        const uploadSection = document.getElementById('upload-section');
        const startWebcamBtn = document.getElementById('start-webcam-btn');
        const captureImageBtn = document.getElementById('capture-image-btn');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const locationText = document.getElementById('locationText');
        const locationInfo = document.getElementById('locationInfo');

        let userRole = null;
        let webcamStream = null;
        let userLocation = null;
        const simulatedLocationName = 'Visakhapatnam, Andhra Pradesh, India';
        
        const setRole = (role) => {
            userRole = role;
            roleSelectScreen.classList.add('hidden');
            if (role === 'buyer') {
                buyerDashboard.classList.remove('hidden');
                setupBuyerDashboard();
            } else {
                sellerDashboard.classList.remove('hidden');
                setupSellerDashboard();
            }
        };

        const initApp = () => {
            ({ db, doc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, appId, userId } = window.firebase);
            console.log("App initialized with user ID:", userId);
            
            roleSelectScreen.classList.remove('hidden');
            buyerBtn.addEventListener('click', () => setRole('buyer'));
            sellerBtn.addEventListener('click', () => setRole('seller'));
        };

        // --- Geolocation and Webcam Functions ---
        const getUserLocation = () => {
            if (navigator.geolocation) {
                locationInfo.classList.remove('hidden');
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        locationText.textContent = simulatedLocationName;
                        console.log('Location obtained:', userLocation);
                    },
                    (error) => {
                        console.error("Geolocation error:", error);
                        locationText.textContent = 'Permission denied or error.';
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                locationInfo.classList.remove('hidden');
                locationText.textContent = 'Geolocation not supported by this browser.';
                console.error("Geolocation not supported.");
            }
        };
        
        startWebcamBtn.addEventListener('click', async () => {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                video.srcObject = webcamStream;
                startWebcamBtn.classList.add('hidden');
                captureImageBtn.classList.remove('hidden');
                getUserLocation();
            } catch (err) {
                console.error("Error accessing the webcam: ", err);
                locationText.textContent = "Error: Could not access webcam. Please check permissions.";
                locationInfo.classList.remove('hidden');
            }
        });

        // --- Firestore & Dashboard Logic ---
        const setupBuyerDashboard = () => {
            requestProductBtn.addEventListener('click', async () => {
                const product = productSelect.value;
                const buyerId = userId;
                await addDoc(collection(db, `artifacts/${appId}/public/data/requests`), {
                    buyerId,
                    product,
                    status: 'pending',
                    createdAt: new Date()
                });
                alert('Product request sent!');
            });
            
            onSnapshot(collection(db, `artifacts/${appId}/public/data/requests`), (snapshot) => {
                buyerRequestsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const request = doc.data();
                    if (request.buyerId === userId) {
                        const productCard = document.createElement('div');
                        productCard.className = 'card flex flex-col items-start';
                        let statusBadgeClass = '';
                        switch(request.status) {
                            case 'pending': statusBadgeClass = 'status-pending'; break;
                            case 'uploaded': statusBadgeClass = 'status-uploaded'; break;
                            case 'verified': statusBadgeClass = 'status-verified'; break;
                            case 'ordered': statusBadgeClass = 'status-ordered'; break;
                            case 'paid': statusBadgeClass = 'status-paid'; break;
                        }
                        
                        productCard.innerHTML = `
                            <p class="text-sm font-medium text-gray-500">Request for: <span class="text-gray-900">${request.product}</span></p>
                            <p class="text-sm font-medium text-gray-500">Status: <span class="status-badge ${statusBadgeClass}">${request.status}</span></p>
                        `;

                        if (request.status === 'uploaded') {
                            const verifyBtn = document.createElement('button');
                            verifyBtn.textContent = 'Verify Product';
                            verifyBtn.className = 'button button-primary text-sm mt-2';
                            verifyBtn.addEventListener('click', async () => {
                                const qualityPercentage = Math.floor(Math.random() * 100) + 1;
                                let rating = 'Poor';
                                if (qualityPercentage > 75) rating = 'Best';
                                else if (qualityPercentage > 50) rating = 'Good';
                                else if (qualityPercentage > 25) rating = 'Average';
                                
                                const orderBtn = document.createElement('button');
                                orderBtn.textContent = 'Place Bulk Order';
                                orderBtn.className = 'button button-primary text-sm mt-2';
                                orderBtn.addEventListener('click', async () => {
                                    await updateDoc(doc.ref, { status: 'ordered', rating });
                                    startPaymentProcess(doc.id, request.product);
                                });

                                await updateDoc(doc.ref, { status: 'verified', rating, qualityPercentage });
                                productCard.innerHTML += `<p class="mt-2 text-sm font-semibold">Rating: ${rating} (${qualityPercentage}%)</p>`;
                                productCard.appendChild(orderBtn);
                                verifyBtn.remove();
                            });
                            productCard.appendChild(verifyBtn);
                        }
                        buyerRequestsList.appendChild(productCard);
                    }
                });
            });
        };

        const setupSellerDashboard = () => {
            onSnapshot(collection(db, `artifacts/${appId}/public/data/requests`), (snapshot) => {
                sellerRequestsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const request = doc.data();
                    if (request.status === 'pending') {
                        const requestCard = document.createElement('div');
                        requestCard.className = 'card flex flex-col items-start';
                        requestCard.innerHTML = `
                            <p class="text-sm font-medium text-gray-500">Product: <span class="text-gray-900">${request.product}</span></p>
                            <p class="text-sm font-medium text-gray-500">Status: <span class="status-badge status-pending">Pending</span></p>
                        `;
                        const fulfillBtn = document.createElement('button');
                        fulfillBtn.textContent = 'Fulfill Request';
                        fulfillBtn.className = 'button button-primary text-sm mt-2';
                        fulfillBtn.addEventListener('click', () => {
                            fulfillRequest(doc.id, request.product);
                        });
                        requestCard.appendChild(fulfillBtn);
                        sellerRequestsList.appendChild(requestCard);
                    }
                });
            });
        };
        
        const fulfillRequest = (requestId, productName) => {
            sellerDashboard.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            
            captureImageBtn.addEventListener('click', async () => {
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                if (userLocation) {
                    context.font = '24px Inter, sans-serif';
                    context.fillStyle = 'white';
                    context.strokeStyle = 'black';
                    context.lineWidth = 4;
                    context.textAlign = 'left';
                    const dateString = new Date().toLocaleString();
                    context.strokeText(simulatedLocationName, 20, canvas.height - 60);
                    context.fillText(simulatedLocationName, 20, canvas.height - 60);
                    context.strokeText(dateString, 20, canvas.height - 30);
                    context.fillText(dateString, 20, canvas.height - 30);
                }

                await updateDoc(doc(db, `artifacts/${appId}/public/data/requests`, requestId), {
                    status: 'uploaded',
                    imageUrl: canvas.toDataURL('image/jpeg'),
                    geoTag: simulatedLocationName,
                    uploadedAt: new Date()
                });
                
                alert('Product image uploaded successfully!');
                uploadSection.classList.add('hidden');
                sellerDashboard.classList.remove('hidden');
            });
        };

        const startPaymentProcess = async (requestId, productName) => {
            const amount = Math.floor(Math.random() * 800) + 200; // Simulates 200kg to 1000kg pricing
            const orderDocRef = doc(db, `artifacts/${appId}/public/data/orders`, requestId);
            
            await setDoc(orderDocRef, {
                buyerId: userId,
                sellerId: 'simulated_seller',
                product: productName,
                totalAmount: amount,
                status: 'pending_payment',
                paymentPlan: '3_months',
                paymentDue: amount / 3,
                month: 1,
                createdAt: new Date()
            });

            showPaymentModal(orderDocRef);
        };

        const showPaymentModal = async (orderDocRef) => {
            const orderSnap = await getDoc(orderDocRef);
            const order = orderSnap.data();
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex justify-center items-center';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                    <h3 class="text-xl font-bold mb-4">Payment for ${order.product}</h3>
                    <p class="mb-2">Total Amount: Rs ${order.totalAmount}</p>
                    <p class="mb-2">Current Due: Rs ${order.paymentDue.toFixed(2)}</p>
                    <p class="mb-4">Payment Plan: ${order.paymentPlan.replace('_', ' ').toUpperCase()}</p>
                    <button id="pay-now-btn" class="button button-primary w-full">Pay Now (Simulated UPI)</button>
                    <button id="close-modal-btn" class="mt-2 w-full button bg-gray-200 text-gray-800">Close</button>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('#pay-now-btn').addEventListener('click', async () => {
                let nextMonth = order.month + 1;
                let nextPlan = order.paymentPlan;
                let newPaymentDue = order.paymentDue;
                
                if (nextMonth === 4) {
                    nextPlan = '6_months';
                    newPaymentDue = (order.totalAmount / 3) + (order.totalAmount / 6);
                } else if (nextMonth === 7) {
                    nextPlan = '1_year';
                    newPaymentDue = (order.totalAmount / 3) + (order.totalAmount / 6) + (order.totalAmount / 12);
                } else if (nextMonth > 12) {
                    alert('Payment not received in 1 year. Buyer reported.');
                    await updateDoc(orderDocRef, { status: 'reported' });
                    modal.remove();
                    return;
                }
                
                if (nextMonth <= 3) {
                    await updateDoc(orderDocRef, {
                        status: 'paid',
                        month: nextMonth
                    });
                    alert(`Payment for month ${order.month} received!`);
                } else {
                    await updateDoc(orderDocRef, {
                        status: 'paid',
                        paymentPlan: nextPlan,
                        paymentDue: newPaymentDue,
                        month: nextMonth
                    });
                    alert(`Payment for ${nextMonth} months received!`);
                }
                
                modal.remove();
            });

            modal.querySelector('#close-modal-btn').addEventListener('click', () => {
                modal.remove();
            });
        };
        
        window.addEventListener('beforeunload', () => {
            if (webcamStream) {
                webcamStream.getTracks().forEach(track => track.stop());
            }
        });
    });
</script>

</body>
</html>
